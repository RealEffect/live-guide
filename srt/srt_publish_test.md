# SRT推流测试

## 测试概要

推流客户端使用OBS和FFmpeg，服务端使用[SLS](sls/sls_overview.md)。在局域网和公网中模拟一些异常网络环境进行测试，通过获取丢包率，分析传输后的媒体文件，输出SRT在不同网络环境下的工况报告。

## 测试项目

### 推流上行丢包环境测试

上行丢包主要模拟推流丢包的场景，推流是直播应用中最关键的环节，通常在互联网用户中相对来说主要是上行负载高，遇到上行链路问题概率较大。

测试环境：

1. 100Mbps局域网，网络包平均延迟小于10ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率13029kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变推流端**网络发送丢包率**。
4. 记录一段时间内不同丢包率下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件输出的`Packet corrupt`进行计算。

|网络丢包率|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 0%|00:04:59.98|7500|7485|0.002%|21555|   3| 0.0139%|1697393| 4427|
| 2%|00:04:59.98|7500|7500|0.000%|21555|   4| 0.0186%|1663405| 5015|
| 4%|00:04:59.98|7500|7485|0.002%|21555|   2| 0.0093%|1672214| 6409|
| 6%|00:04:59.98|7500|7485|0.002%|21555|   6| 0.0278%|1695242| 7869|
| 8%|00:04:59.98|7500|7500|0.000%|21555|   4| 0.0186%|1712633| 9238|
|10%|00:04:59.98|7500|7486|0.002%|21555|   6| 0.0278%|1733669|10813|
|15%|00:04:59.98|7500|7486|0.002%|21555|   8| 0.0371%|1776731|14056|
|20%|00:04:59.98|7500|7486|0.002%|21555|  14| 0.0650%|1811131|16881|
|30%|00:04:59.98|7500|7486|0.002%|21555|  22| 0.1021%|1855679|21480|
|50%|00:04:59.98|7500|7501|0.000%|21555| 168| 0.7794%|1849880|26683|
|80%|00:04:59.98|7500|7492|0.001%|21555|5614|26.0450%|1625378|30711|

这个测试场景下，50%及以下的丢包率传输后的媒体流解码画面基本都是正常的，在80%丢包率情况下只有极少的画面可以正常解码显示，整体都是大面积的马赛克。

### 推流下行丢包环境测试

上行丢包主要模拟推流丢包的场景。

测试环境：

1. 100Mbps局域网，网络包平均延迟小于10ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率13029kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变推流端**网络接收丢包率**。
4. 记录一段时间内不同丢包率下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件中的`Packet corrupt`进行计算。

|网络丢包率|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 5%|00:04:59.98|7500||||||||
|10%|00:04:59.98|7500||||||||
|30%|00:04:59.98|7500||||||||
|50%|00:04:59.98|7500||||||||
|80%|00:04:59.98|7500||||||||

### 互联网带宽限制下的丢包场景测试

测试环境：

1. 公网带宽20Mbps，终端到服务器平均延迟46ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

## 参考资料
