# SRT推流测试

## 测试概要

推流客户端使用OBS和FFmpeg，服务端使用[SLS](sls/sls_overview.md)。在局域网和公网中模拟一些异常网络环境进行测试，通过获取丢包率，分析传输后的媒体文件，输出SRT在不同网络环境下的工况报告。

## 测试项目

### 推流丢包环境测试

上行丢包主要模拟推流丢包的场景，推流是直播应用中最关键的环节，通常在互联网用户中相对来说主要是上行负载高，遇到上行链路问题概率较大。

测试环境：

1. 100Mbps局域网，网络包平均RTT小于10ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率13029kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变服务端**网络随机丢包率**。
4. 记录一段时间内不同丢包率下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件输出的`Packet corrupt`进行计算。

|网络丢包率|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 0%|00:04:59.98|7500|7485|0.002%|21555|   3| 0.0139%|1697393| 4427|
| 2%|00:04:59.98|7500|7500|0.000%|21555|   4| 0.0186%|1663405| 5015|
| 4%|00:04:59.98|7500|7485|0.002%|21555|   2| 0.0093%|1672214| 6409|
| 6%|00:04:59.98|7500|7485|0.002%|21555|   6| 0.0278%|1695242| 7869|
| 8%|00:04:59.98|7500|7500|0.000%|21555|   4| 0.0186%|1712633| 9238|
|10%|00:04:59.98|7500|7486|0.002%|21555|   6| 0.0278%|1733669|10813|
|15%|00:04:59.98|7500|7486|0.002%|21555|   8| 0.0371%|1776731|14056|
|20%|00:04:59.98|7500|7486|0.002%|21555|  14| 0.0650%|1811131|16881|
|30%|00:04:59.98|7500|7486|0.002%|21555|  22| 0.1021%|1855679|21480|
|50%|00:04:59.98|7500|7501|0.000%|21555| 168| 0.7794%|1849880|26683|
|80%|00:04:59.98|7500|7492|0.001%|21555|5614|26.0450%|1625378|30711|

这个测试场景下，50%及以下的丢包率传输后的媒体流解码画面基本都是正常的，在80%丢包率情况下只有极少的画面可以正常解码显示，整体都是大面积的马赛克。

### 推流下行丢包环境测试

下行丢包主要模拟推流下行网络不稳定丢包的场景。

测试环境：

1. 100Mbps局域网，网络包平均RTT小于10ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率13029kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变推流端**网络接收丢包率**。
4. 记录一段时间内不同丢包率下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件中的`Packet corrupt`进行计算。

|网络丢包率|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 5%|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1646452|4552|
|10%|00:04:59.98|7500|7485|0.002%|21555|3|0.0139%|1640919|4550|
|20%|00:04:59.98|7500|7485|0.002%|21555|3|0.0139%|1640833|4577|
|30%|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1640726|4609|
|50%|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1640346|4640|
|70%|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1640082|4705|

这个测试场景下，视频画面和数据都没有明显异常，包损坏率基本不变，媒体文件播放流畅清晰。但是在80%丢包率下连接无法建立。

### 网络延迟环境测试

在实际的互联网传输中都会有网络包传输延迟，这里模拟不同延迟情况下的工况。

测试环境：

1. 100Mbps局域网，网络包平均RTT小于10ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率13029kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变推流端**网络发送接收延迟时长**。
4. 记录一段时间内不同RTT下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件中的`Packet corrupt`进行计算。

|RTT|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 20ms|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1646396|4649|
| 30ms|00:04:59.98|7500|7486|0.002%|21555|2|0.0093%|1646055|4765|
| 50ms|00:04:59.98|7500|7485|0.002%|21555|2|0.0093%|1645898|4617|
| 80ms|00:04:59.98|7500|7486|0.002%|21555|2|0.0093%|1645886|4506|
|150ms|00:04:59.98|7500|7486|0.002%|21555|2|0.0093%|1645836|4288|
|300ms|00:04:59.98|7500|7487|0.002%|21555|3|0.0139%|1634931|4281|
|600ms|00:04:59.98|7500|7483|0.003%|21555|2|0.0093%|1640332|4347|

RTT到达600毫秒时，srt触发超时丢包的概率较高，但是视频数据还是基本正常。

### 互联网带宽限制下的丢包场景测试

测试环境：

1. 公网带宽上行10Mbps，下行10Mbps，终端到服务器平均RTT等于47ms，丢包率小于1%。
2. ffmpeg在windows端推流，sls部署在Linux收流。
3. 客户端测试环境中CPU占用始终小于10%，服务端小于1%，不开启其它占用网络和性能的软件。

测试方法：

1. 使用ffmpeg将本地TS媒体文件(码率6580kbps)通过srt推流到sls服务。
2. `SRT最大延迟`参数设置为300毫秒，其它参数维持默认值。
3. 通过网络工况模拟工具改变推流端**网络丢包率**。
4. 记录一段时间内不同丢包率下发送的视频帧数和服务端输出帧数，通过wireshark记录链路上下行带宽平均值。

帧数统计方法：发送帧数通过推流端统计，输出帧数通过服务端转写文件统计。
媒体流包统计方法：发送的媒体包数通过推流端文件计算，异常包通过ffmpeg分析服务端转写文件中的`Packet corrupt`进行计算。

|网络丢包率|时长|发送帧数|输出帧数|丢帧率|发送包|损坏包|损坏率|上行带宽|下行带宽|
|-|-|-|-|-|-|-|-|-|-|
| 0%|00:01:59.97|3000|2993|0.003%|8000|   2| 0.0250%|1072769| 3639|
| 2%|00:01:59.97|3000|2993|0.003%|8000|   2| 0.0250%| 874484| 4289|
| 4%|00:01:59.97|3000|2993|0.003%|8000|   4| 0.0500%| 885992| 4931|
| 6%|00:01:59.97|3000|2993|0.003%|8000|   6| 0.0750%| 911559| 5991|
| 8%|00:01:59.97|3000|2993|0.003%|8000|   6| 0.0750%| 927046| 6631|
|10%|00:01:59.97|3000|2993|0.003%|8000|   9| 0.1125%| 944995| 7427|
|15%|00:01:59.97|3000|2998|0.001%|8000|  12| 0.1500%| 969901| 9332|
|20%|00:01:59.97|3000|2992|0.003%|8000|  30| 0.3750%| 986974|10474|
|30%|00:01:59.97|3000|2990|0.003%|8000| 155| 1.9375%|1012659|13203|
|50%|00:01:59.97|3000|2888|0.038%|8000|1142|14.2750%| 976408|18488|
|80%|00:01:59.97|3000|none|  none|8000|none|    none|   none| none|

50%丢包情况下，大概率出现连接建立失败。80%丢包率情况下，连接很难建立，即使连接建立后续大概率会出现超时断开。

## 参考资料
